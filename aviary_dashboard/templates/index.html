<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê• Dashboard do Avi√°rio</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background-color: #f8f9fa; /* Fundo claro */
            color: #343a40; /* Texto escuro */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background-color: #007bff; /* Azul prim√°rio para a navbar */
            color: white;
        }
        .navbar-brand {
            color: white !important;
            font-weight: bold;
        }
        .card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: #e9ecef; /* Cabe√ßalho mais claro */
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            color: #495057;
            padding: 1rem 1.5rem; /* Ajusta o padding do cabe√ßalho */
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff; /* Azul prim√°rio para os valores */
        }
        .metric-label {
            font-size: 0.9rem;
            color: #6c757d; /* Cinzento para as legendas */
        }
        .control-btn {
            width: 100%;
            padding: 0.75rem;
            font-size: 1.1rem;
            border-radius: 0.5rem;
            margin-bottom: 10px;
        }
        .control-btn.btn-on {
            background-color: #28a745; /* Verde para ON */
            border-color: #28a745;
            color: white;
        }
        .control-btn.btn-off {
            background-color: #dc3545; /* Vermelho para OFF */
            border-color: #dc3545;
            color: white;
        }
        .control-btn i {
            margin-right: 8px;
        }
        /* Responsividade para tablets - Ajusta o tamanho das colunas dos m√©tricos */
        @media (min-width: 768px) {
            .sensor-metrics .col-md-4 {
                flex: 0 0 auto;
                width: 33.33333333%;
            }
        }

        /* --- Novo CSS para controlar a altura do gr√°fico --- */
        .chart-container {
            position: relative; /* Importante para o Chart.js */
            height: 300px; /* **Define a altura fixa para o gr√°fico em ecr√£s pequenos** */
            width: 100%;
            margin: auto; /* Centraliza o cont√™iner */
            /* overflow: hidden; */ /* Descomenta se quiseres cortar conte√∫do que transborda */
        }

        /* Ajustar a altura em ecr√£s maiores (ex: tablets) */
        @media (min-width: 768px) {
            .chart-container {
                height: 350px; /* Um pouco mais alto para tablets */
            }
        }

        /* Ajustar a altura em ecr√£s ainda maiores (ex: desktops) */
        @media (min-width: 992px) {
            .chart-container {
                height: 400px; /* Ainda mais alto para desktops */
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">üê• Dashboard do Avi√°rio</a>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header">
                üì° Leitura Atual dos Sensores
            </div>
            <div class="card-body">
                <div class="row g-3 text-center sensor-metrics">
                    <div class="col-6 col-md-4">
                        <div class="p-3 bg-light rounded shadow-sm">
                            <i class="fas fa-thermometer-half fa-2x mb-2 text-primary"></i>
                            <div class="metric-value" id="tempValue">--.-</div>
                            <div class="metric-label">Temperatura (¬∫C)</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="p-3 bg-light rounded shadow-sm">
                            <i class="fas fa-water fa-2x mb-2 text-info"></i>
                            <div class="metric-value" id="humidValue">--.-</div>
                            <div class="metric-label">Humidade (%)</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="p-3 bg-light rounded shadow-sm">
                            <i class="fas fa-lightbulb fa-2x mb-2 text-warning"></i>
                            <div class="metric-value" id="lumiValue">---</div>
                            <div class="metric-label">Luminosidade</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="p-3 bg-light rounded shadow-sm">
                            <i class="fas fa-fire-extinguisher fa-2x mb-2 text-danger"></i>
                            <div class="metric-value" id="gasValue">---</div>
                            <div class="metric-label">G√°s Detetado</div>
                        </div>
                    </div>
                     <div class="col-6 col-md-4">
                        <div class="p-3 bg-light rounded shadow-sm">
                            <i class="fas fa-fan fa-2x mb-2 text-secondary"></i>
                            <div class="metric-value" id="fanState">---</div>
                            <div class="metric-label">Ventoinhas</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="p-3 bg-light rounded shadow-sm">
                            <i class="fas fa-window-restore fa-2x mb-2 text-secondary"></i>
                            <div class="metric-value" id="windowState">---</div>
                            <div class="metric-label">Janelas</div>
                        </div>
                    </div>
                </div>
                <p class="text-end mt-3 mb-0"><small class="text-muted">√öltima atualiza√ß√£o: <span id="timestampValue">--:--:--</span></small></p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                üõ†Ô∏è Controlo Manual dos Atuadores
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <button id="toggleVentoinha" class="btn btn-primary control-btn" data-state="0">
                            <i class="fas fa-fan"></i> Ventoinhas: Desligadas
                        </button>
                    </div>
                    <div class="col-12 col-md-6">
                        <button id="toggleJanela" class="btn btn-primary control-btn" data-state="0">
                            <i class="fas fa-window-restore"></i> Janelas: Fechadas
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                üìà Hist√≥rico
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="sensorChart"></canvas>
                </div>
                <h5 class="mt-4">√öltimos Registos</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Temp (¬∫C)</th>
                                <th>Hum (%)</th>
                                <th>Lumi</th>
                                <th>G√°s</th>
                                <th>Ventoinhas</th>
                                <th>Janelas</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>

    <script>
        const socket = io(); // Conecta ao servidor SocketIO
        let sensorChart; // Vari√°vel para a inst√¢ncia do Chart.js

        // --- Configura√ß√£o dos Limites ---
        const MAX_CHART_DATA_POINTS = 60; // N√∫mero m√°ximo de pontos no gr√°fico (ex: para 1 min a 1 seg/ponto)
        const MAX_TABLE_ROWS = 15;       // N√∫mero m√°ximo de linhas na tabela do hist√≥rico

        // Fun√ß√£o para inicializar o gr√°fico
        function initChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // Horas
                    datasets: [
                        {
                            label: 'Temperatura (¬∫C)',
                            data: [],
                            borderColor: 'rgba(0, 123, 255, 0.8)', // Azul
                            backgroundColor: 'rgba(0, 123, 255, 0.2)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3, // Tamanho dos pontos
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Humidade (%)',
                            data: [],
                            borderColor: 'rgba(23, 162, 184, 0.8)', // Ciano
                            backgroundColor: 'rgba(23, 162, 184, 0.2)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Luminosidade',
                            data: [],
                            borderColor: 'rgba(255, 193, 7, 0.8)', // Amarelo
                            backgroundColor: 'rgba(255, 193, 7, 0.2)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Permite que o gr√°fico se ajuste √† altura do cont√™iner
                    animation: {
                        duration: 0 // Desativa a anima√ß√£o para atualiza√ß√µes mais r√°pidas
                    },
                    scales: {
                        x: {
                            reverse: false, // Garante que o tempo avan√ßa da esquerda para a direita
                            title: {
                                display: true,
                                text: 'Hora'
                            }
                        },
                        y: {
                            beginAtZero: false, // Pode ser false para escalas mais realistas
                            title: {
                                display: true,
                                text: 'Valor'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Hist√≥rico de Sensores'
                        }
                    }
                }
            });
        }

        // Fun√ß√£o para atualizar os valores dos sensores na UI
        function updateSensorMetrics(data) {
            document.getElementById('tempValue').innerText = data.temperatura !== null ? data.temperatura.toFixed(1) : '--.-';
            document.getElementById('humidValue').innerText = data.humidade !== null ? data.humidade.toFixed(1) : '--.-';
            document.getElementById('lumiValue').innerText = data.luminosidade !== null ? data.luminosidade : '---';
            document.getElementById('gasValue').innerText = data.gas !== null ? (data.gas ? 'Sim' : 'N√£o') : '---';
            
            document.getElementById('timestampValue').innerText = data.timestamp !== null ? data.timestamp : '--:--:--';

            // Atualiza os bot√µes de controlo com base no estado atual dos atuadores
            const toggleVentoinhaBtn = document.getElementById('toggleVentoinha');
            const toggleJanelaBtn = document.getElementById('toggleJanela');

            if (data.ventoinha !== null) {
                toggleVentoinhaBtn.dataset.state = data.ventoinha ? '1' : '0';
                toggleVentoinhaBtn.classList.remove('btn-primary', 'btn-on', 'btn-off'); // Remove classes anteriores
                toggleVentoinhaBtn.classList.add(data.ventoinha ? 'btn-on' : 'btn-off'); // Adiciona a correta
                toggleVentoinhaBtn.innerHTML = `<i class="fas fa-fan"></i> Ventoinhas: ${data.ventoinha ? 'Ligadas' : 'Desligadas'}`;
            } else {
                 toggleVentoinhaBtn.classList.remove('btn-on', 'btn-off');
                 toggleVentoinhaBtn.classList.add('btn-primary'); // Volta para o estado padr√£o
                 toggleVentoinhaBtn.innerHTML = `<i class="fas fa-fan"></i> Ventoinhas: ---`;
            }

            if (data.janela !== null) {
                toggleJanelaBtn.dataset.state = data.janela ? '1' : '0';
                toggleJanelaBtn.classList.remove('btn-primary', 'btn-on', 'btn-off');
                toggleJanelaBtn.classList.add(data.janela ? 'btn-on' : 'btn-off');
                toggleJanelaBtn.innerHTML = `<i class="fas fa-window-restore"></i> Janelas: ${data.janela ? 'Abertas' : 'Fechadas'}`;
            } else {
                toggleJanelaBtn.classList.remove('btn-on', 'btn-off');
                toggleJanelaBtn.classList.add('btn-primary');
                toggleJanelaBtn.innerHTML = `<i class="fas fa-window-restore"></i> Janelas: ---`;
            }
        }

        // Fun√ß√£o para adicionar um novo registo ao hist√≥rico e atualizar o gr√°fico
        function addHistoryRecord(record) {
            // --- Atualiza a tabela ---
            const tableBody = document.getElementById('historyTableBody');
            const newRow = tableBody.insertRow(0); // Adiciona no topo da tabela
            newRow.insertCell(0).innerText = record.Hora;
            newRow.insertCell(1).innerText = record.Temperatura !== null ? record.Temperatura.toFixed(1) : '---';
            newRow.insertCell(2).innerText = record.Humidade !== null ? record.Humidade.toFixed(1) : '---';
            newRow.insertCell(3).innerText = record.Luminosidade !== null ? record.Luminosidade : '---';
            newRow.insertCell(4).innerText = record.G√°s;
            newRow.insertCell(5).innerText = record.Ventoinhas_Estado;
            newRow.insertCell(6).innerText = record.Janelas_Estado;

            // Limita o n√∫mero de linhas na tabela
            if (tableBody.rows.length > MAX_TABLE_ROWS) {
                tableBody.deleteRow(MAX_TABLE_ROWS); // Remove a linha mais antiga (a √∫ltima na tabela)
            }

            // --- Atualiza o gr√°fico ---
            if (sensorChart) { // Garante que o gr√°fico foi inicializado
                // Adiciona o novo ponto de dados
                sensorChart.data.labels.push(record.Hora);
                sensorChart.data.datasets[0].data.push(record.Temperatura);
                sensorChart.data.datasets[1].data.push(record.Humidade);
                sensorChart.data.datasets[2].data.push(record.Luminosidade);

                // Remove o ponto de dados mais antigo se exceder o limite
                if (sensorChart.data.labels.length > MAX_CHART_DATA_POINTS) {
                    sensorChart.data.labels.shift(); // Remove a primeira hora
                    sensorChart.data.datasets[0].data.shift(); // Remove a primeira temperatura
                    sensorChart.data.datasets[1].data.shift(); // Remove a primeira humidade
                    sensorChart.data.datasets[2].data.shift(); // Remove a primeira luminosidade
                }
                
                sensorChart.update(); // IMPORANTE: Atualiza o gr√°fico para refletir as mudan√ßas
            }
        }

        // === Socket.IO Event Listeners ===
        socket.on('connect', () => {
            console.log('Conectado ao servidor WebSocket!');
        });

        socket.on('new_sensor_data', (data) => {
            console.log('Dados de sensor recebidos:', data);
            updateSensorMetrics(data); // Atualiza os m√©tricos principais

            // Adiciona ao hist√≥rico apenas se os dados de sensor estiverem completos
            // e se o timestamp mudou para evitar duplicados muito r√°pidos
            const lastRecordTime = sensorChart.data.labels.length > 0 ? sensorChart.data.labels[sensorChart.data.labels.length - 1] : null;
            if (data.temperatura !== null && data.humidade !== null && data.luminosidade !== null && data.gas !== null && data.timestamp !== lastRecordTime) {
                 addHistoryRecord({
                    Hora: data.timestamp,
                    Temperatura: data.temperatura,
                    Humidade: data.humidade,
                    Luminosidade: data.luminosidade,
                    G√°s: data.gas ? 'Sim' : 'N√£o',
                    Ventoinhas_Estado: data.ventoinha ? 'Ligadas' : 'Desligadas',
                    Janelas_Estado: data.janela ? 'Abertas' : 'Fechadas'
                });
            }
        });

        socket.on('initial_history', (historyArray) => {
            console.log('Hist√≥rico inicial recebido:', historyArray);
            
            // Limpa o gr√°fico e a tabela antes de carregar o hist√≥rico inicial
            if (sensorChart) {
                sensorChart.data.labels = [];
                sensorChart.data.datasets.forEach(dataset => dataset.data = []);
            }
            document.getElementById('historyTableBody').innerHTML = '';

            // Adiciona os registos do hist√≥rico um a um (em ordem cronol√≥gica)
            // Reverse a array para adicionar do mais antigo para o mais recente,
            // garantindo a ordem correta no gr√°fico e na tabela
            historyArray.reverse().forEach(record => {
                addHistoryRecord(record);
            });
            // O gr√°fico j√° √© atualizado dentro de addHistoryRecord, mas uma final update pode ser √∫til
            if (sensorChart) sensorChart.update();
        });


        // === Event Listeners para os Bot√µes de Controlo ===
        document.getElementById('toggleVentoinha').addEventListener('click', function() {
            let currentState = parseInt(this.dataset.state); // 0 ou 1
            let newState = 1 - currentState; // Inverte o estado
            socket.emit('toggle_actuator', { type: 'ventoinha', state: newState });
        });

        document.getElementById('toggleJanela').addEventListener('click', function() {
            let currentState = parseInt(this.dataset.state); // 0 ou 1
            let newState = 1 - currentState; // Inverte o estado
            socket.emit('toggle_actuator', { type: 'janela', state: newState });
        });

        // Inicializa o gr√°fico quando a p√°gina carrega
        window.onload = initChart;
    </script>
</body>
</html>